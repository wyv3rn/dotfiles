#!/usr/bin/env bash

if [ $# -ne 2 ]; then
    echo "Usage: yt-pl id name"
fi

list_id=$1
list_name=$2

opus_dir="${HOME}/Music/opus"
pl_dir="${HOME}/Music/playlists/${list_name}"
mkdir -p $pl_dir

track_ids=$(yt-dlp --skip-download https://music.youtube.com/playlist?list=${list_id} 2>/dev/null | sed -n 's/^.*Extracting URL:.*\?v\=\(.*\)/\1/p')

number=1
for track_id in $track_ids; do
    echo "[${number}] Downloading track_id = ${track_id}"
    dst=$(yt-dlp -x --audio-format opus --embed-metadata https://music.youtube.com/watch?v=${track_id} -o "${opus_dir}/%(artists.0)s/%(album)s/%(track)s.%(ext)s" --restrict-filenames | grep -o "\S\+\.opus" | head -n1)
    if [ "${dst}" == "" ]; then
        echo "[${number}] Failed to get destination file, skipping linking!"
        continue
    fi
    echo "[${number}] Written to ${dst}"
    link_name="$(printf "%03d" $number)_$(basename $dst)"
    echo "[${number}] Linking as ${link_name}"
    ln -s $dst "${pl_dir}/${link_name}"
    ((number+=1))
done
