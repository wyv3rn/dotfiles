#!/usr/bin/env bash

if [ $# -lt 3 ]; then
    echo "Usage: yt-pl init|add id name [options]"
    exit -1
fi

cmd=$1
id=$2
list_name=$3

music_dir="${HOME}/Music"
opus_dir="${music_dir}/opus"
playlists_dir="${music_dir}/playlists"
albums_dir="${music_dir}/playlists"

m3u_file="${playlists_dir}/${list_name}.m3u"

extra_flags=""

while [ $# -gt 0 ]; do
    case $1 in
        --cookies)
            extra_flags="${extra_flags} --cookies-from-browser brave"
            ;;
        --album)
            m3u_file="${albums_dir}/${list_name}.m3u"
            ;;
    esac
    shift
done

case $cmd in
    init)
        list_id=$(echo $id | sed -n "s/.*list=\(.*\)&si=.*/\1/p")
        echo "List ID = ${list_id}"
        track_ids=$(yt-dlp --skip-download https://music.youtube.com/playlist?list=${list_id} 2>/dev/null | sed -n 's/^.*Extracting URL:.*?v=\(.*\)/\1/p')
        ;;
    add)
        track_id=$(echo $id | sed -n "s/.*watch?v=\(.*\)&si=.*/\1/p")
        echo "Track ID = ${track_id}"
        track_ids=($track_id)
        ;;
    *)
        echo "Unknown subcommand ${cmd}"
        exit -1
        ;;
esac

for track_id in $track_ids; do
    echo "Downloading track_id = ${track_id}"
    dst=$(yt-dlp ${extra_flags} -x --audio-format opus --embed-metadata https://music.youtube.com/watch?v=${track_id} -o "${opus_dir}/%(artists.0)s/%(album)s/%(track)s.%(ext)s" --restrict-filenames | grep -o "\S\+\.opus" | head -n1)
    if [ "${dst}" == "" ]; then
        echo "Failed to get destination file, skipping linking!"
        continue
    fi
    if [[ "${dst}" == */NA.opus ]]; then
        new_dst="${opus_dir}/NA/${track_id}.opus"
        mv $dst $new_dst
        dst=$new_dst
        rmdir "${opus_dir}/NA/NA/"
    fi
    echo "Written to ${dst}"
    rel_dst=$(echo $dst | sed 's/^\/.*\/.*\/Music/../')
    echo $rel_dst >> $m3u_file
done
