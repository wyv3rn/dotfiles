#!/usr/bin/env bash

if [ $# -lt 3 ]; then
    echo "Usage: yt-pl init|add id name [options]"
    exit -1
fi

cmd=$1
id=$2
list_name=$3

extra_flags=""

while [ $# -gt 0 ]; do
    case $1 in
        --cookies)
            extra_flags="${extra_flags} --cookies-from-browser brave"
            ;;
    esac
    shift
done

opus_dir="${HOME}/Music/opus"
pl_dir="${HOME}/Music/playlists/${list_name}"
m3u_file="${pl_dir}/playlist.m3u"
mkdir -p $pl_dir

case $cmd in
    init)
        list_id=$(echo $id | sed -n "s/.*list\=\(.*\)&si\=.*/\1/p")
        echo "List ID = ${list_id}"
        track_ids=$(yt-dlp --skip-download https://music.youtube.com/playlist?list=${list_id} 2>/dev/null | sed -n 's/^.*Extracting URL:.*\?v\=\(.*\)/\1/p')
        number=1
        ;;
    add)
        track_id=$(echo $id | sed -n "s/.*watch\?v\=\(.*\)&si\=.*/\1/p")
        echo "Track ID = ${track_id}"
        track_ids=($track_id)
        if [ ! -f $m3u_file ]; then
            echo "Expected playlist file to exist already"
            exit -1
        fi
        number=$(wc -l ${m3u_file} | awk '{print $1}')
        ((number+=1))
        ;;
    *)
        echo "Unknown subcommand ${cmd}"
        exit -1
        ;;
esac

for track_id in $track_ids; do
    echo "[${number}] Downloading track_id = ${track_id}"
    dst=$(yt-dlp ${extra_flags} -x --audio-format opus --embed-metadata https://music.youtube.com/watch?v=${track_id} -o "${opus_dir}/%(artists.0)s/%(album)s/%(track)s.%(ext)s" --restrict-filenames | grep -o "\S\+\.opus" | head -n1)
    if [ "${dst}" == "" ]; then
        echo "[${number}] Failed to get destination file, skipping linking!"
        continue
    fi
    echo "[${number}] Written to ${dst}"
    rel_dst=$(echo $dst | sed 's/\/.*\/.*\/Music/..\/../')
    link_name="$(printf "%03d" $number)_$(basename $dst)"
    echo "[${number}] Linking ${link_name} -> ${rel_dst}"
    ln -s ${rel_dst} "${pl_dir}/${link_name}"
    echo $link_name >> $m3u_file
    ((number+=1))
done
