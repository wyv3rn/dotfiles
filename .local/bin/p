#!/usr/bin/env bash

function force-curses() {
    # TODO this is probably not enough on linux
    export GPG_TTY=$(tty)
    export PINENTRY_USER_DATA="USE_CURSES=1"
}

function fullprompt() {
    read -p "Username: " user
    pw=$(pwprompt)
    if [ $? -ne 0 ]; then
        exit $?
    fi
    value="${user}"$'\n'"${pw}"
    echo "$value"
}

function pwprompt() {
    read -s -p "Password: " pw
    read -s -p "Again: " pwcheck

    if [ ! "$pw" == "$pwcheck" ]; then
        echo "Passwords do not match" >&2
        exit -1
    fi
    unset -v pwcheck
    echo $pw
}

function add() {
    key=$1
    master=$2
    filename="${pwdir}/${key}"
    value=$(fullprompt)
    if [ $? -ne 0 ]; then
        exit $?
    fi
    xtraflags=""

    if [ ! "$master" == "" ]; then
        xtraflags="--passphrase ${master} --batch"
    fi

    force-curses
    echo -n "$value" | gpg -c --armor --no-symkey-cache $xtraflags > $filename

    unset -v pw
}

fzfprg="fzf"

if [ "$(uname)" == "Darwin" ]; then
    clip="pbcopy"
else
    clip="xclip -selection clipboard"
fi

pwdir="${HOME}/.pstore"
if [ ! -d $pwdir ]; then
    mkdir $pwdir
fi

if [ "$1" == "add" ]; then
    if [ $# -ne 2 ]; then
        echo "Usage: p add <key>"
        exit -2
    fi
    add $2
elif [ "$1" == "batch" ]; then
    echo "Master first"
    master=$(pwprompt)
    echo ""
    echo "Entries next, quit with empty key"
    while true; do
        echo ""
        read -p "Key: " key
        if [ "$key" == "" ]; then
            break
        fi
        add $key $master
    done
    unset -v master
elif [ "$1" == "clear" ]; then
    echo -n "Clear!" | $clip
else
    if [ "$1" == "--gui" ]; then
        fzfprg="gfzf"
    else
        force-curses
    fi
    key=$(ls $pwdir | $fzfprg)
    if [ "$key" == "" ]; then
        exit 0
    fi
    plain=$(gpg -d --no-symkey-cache "${pwdir}/${key}")
    echo -n "$plain" | head -n1
    echo -n "$plain" | tail -n1 | $clip
fi
