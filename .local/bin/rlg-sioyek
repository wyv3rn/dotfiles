#!/usr/bin/env bash

function sioyek_helper() {
    PDF=$1
    SCHEMA=$2
    DB=$3
    JSON=$4

    #  Convert state to db
    rm "$DB" || true
    sqlite3 "$DB" -cmd ".parameter set :jsonfile '$JSON'" < "$SCHEMA"

    #  Run sioyek
    sioyek --shared-database-path $DB $PDF

    # Export SQLite -> JSON
    {
        echo '{'
        first=1
        for table in marks bookmarks highlights links; do
            [ $first -eq 1 ] || echo ','
            first=0
            echo "\"$table\":"
            array=$(sqlite3 -json "$DB" "SELECT * FROM $table;")
            if [ -z "${array}"]; then
                array="[]"
            fi
            echo $array
        done
        echo '}'
    } | jq > "$JSON"

    rm "$DB" || true
}

if [ $# -ne 4 ]; then
    echo "Usage: rlg-sioyek file schema_path db_sqlite_path db_json_path"
    exit -1
fi
export -f sioyek_helper
params="$@"
bash -c "sioyek_helper ${params}" >/dev/null 2>&1 &
