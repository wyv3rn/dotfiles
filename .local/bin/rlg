#!/usr/bin/env bash

# TODO make these globals configurable
library="${HOME}/.library"
bib_dir="${library}/bib"
bib_dir_sed_esc=$(echo $bib_dir | sed 's/\//\\\//g')
pdf_dir="${library}/pdf"
collection_dir="${library}/collections"

viewer="rlg-sioyek"
editor="nvim"
db_schema="${library}/bootstrap.sql"
db_json="${library}/state.json"
db="${library}/sioyek.db"
browser="qutebrowser"

# some OS specific commands
if [ "$(uname)" == "Darwin" ]; then
    clip="pbcopy"
else
    clip="xclip -selection clipboard"
fi

# cmds/helper functions
function do_open() {
    pdf="${pdf_dir}/${1}.pdf"
    bib="${bib_dir}/${1}.bib"
    data=$(cat $bib)
    url_re="url ?= ?{([^}]*)}"
    doi_re="doi ?= ?{([^}]*)}"

    if [[ -f $pdf && usedoi -ne 1 ]]; then
        $viewer $pdf $db_schema $db $db_json
    elif [[ "$data" =~ $url_re ]]; then
        $browser "${BASH_REMATCH[1]}"
    elif [[ "$data" =~ $doi_re ]]; then
        $browser "https://doi.org/${BASH_REMATCH[1]}"
    else
        echo "Do not know how to open ${1}"
        exit -1
    fi
}

function show() {
    cat "${library}/bib/${1}.bib"
}

function edit() {
    $editor "${bib_dir}/${1}.bib"
}

function yank() {
    show $@ | $clip
}

function do_fzf() {
    list=$(ls $bib_dir | sed 's/\.bib$//')
    do_open $(echo "$list" | $fzfprg)
}

function do_export() {
    collection="${collection_dir}/${1}.txt"
    files=$(sed "s/^\(.*\)$/${bib_dir_sed_esc}\/\1.bib/" ${collection})
    awk 'FNR==1 && NR!=1 {print ""} {print}' $files | sed "s/\(^@[^{]*{\)/\1${prefix}/" > $output
}

function addto() {
    collection="${collection_dir}/${1}.txt"
    item=$2
    bib_file="${bib_dir}/${item}.bib"
    if [[ ! -f $bib_file ]]; then
        echo "Do not know ${item}!"
        exit -1
    fi
    echo $item >> $collection
    sort -u -o $collection $collection
}

function rmfrom() {
    collection="${collection_dir}/${1}.txt"
    item=$2
    sed -i '' "/^${item}$/d" $collection
}

# parse args
if [ $# -lt 1 ]; then
    echo "No subcommand given!"
    exit -1
fi

cmd=$1
shift
if [ "$cmd" == "fzf" ]; then
    cmd="do_fzf" # avoiding name clash with fzf programm
elif [ "$cmd" == "open" ]; then
    cmd="do_open"
elif [ "$cmd" == "export" ]; then
    cmd="do_export"
fi

# defaults for named args
usedoi=0
fzfprg="fzf"
output="/dev/stdout"

posargs=()
while [ $# -gt 0 ]; do
    case $1 in
        -o|--output)
            output=$2
            shift
            ;;
        -p|--prefix)
            prefix=$2
            shift
            ;;
        --doi)
            usedoi=1
            ;;
        --gui)
            fzfprg="gfzf"
            ;;
        *)
            posargs+=($1)
            ;;
    esac
    shift
done

# perform the command
$cmd ${posargs[@]}
