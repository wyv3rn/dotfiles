#!/usr/bin/env bash

# TODO make these globals configurable
library="${HOME}/.library"
bib_dir="${library}/bib"
bib_dir_sed_esc=$(echo $bib_dir | sed 's/\//\\\//g')
pdf_dir="${library}/pdf"

viewer="rlg-sioyek"
editor="nvim"
db_schema="${library}/bootstrap.sql"
db_json="${library}/state.json"
db="${library}/sioyek.db"
browser="qutebrowser"

# some OS specific commands
if [ "$(uname)" == "Darwin" ]; then
    clip="pbcopy"
else
    clip="xclip -selection clipboard"
fi

# cmds/helper functions
function do_open() {
    item=$(get_item $@)
    pdf="${pdf_dir}/${item}.pdf"
    bib="${bib_dir}/${item}.bib"
    data=$(cat $bib)
    url_re="url ?= ?\{([^}]*)\}"
    doi_re="doi ?= ?\{([^}]*)\}"

    if [[ -f $pdf && usedoi -ne 1 ]]; then
        $viewer $pdf $db_schema $db $db_json
    elif [[ "$data" =~ $url_re ]]; then
        $browser "${BASH_REMATCH[1]}"
    elif [[ "$data" =~ $doi_re ]]; then
        $browser "https://doi.org/${BASH_REMATCH[1]}"
    else
        echo "Do not know how to open ${item}"
        exit -1
    fi
}

function get_item() {
    if [ $# -gt 0 ]; then
        echo $1
    else
        list=$(ls $bib_dir | sed 's/\.bib$//')
        echo "$list" | $fzfprg
    fi
}

function show() {
    item=$(get_item $@)
    cat "${library}/bib/${item}.bib"
}

function edit() {
    item=$(get_item $@)
    $editor "${bib_dir}/${item}.bib"
}

function yank() {
    show $@ | $clip
}

function do_diff() {
    if [ $# -lt 1 ]; then
        echo "Usage: rlg diff some-file.bib"
        exit -1
    fi
    collection=$1

    entries=()
    current_entry=""
    while read -r; do
        if [[ $REPLY ]]; then
            if [[ $current_entry ]]; then
                current_entry+=$'\n'"$REPLY"
            else
                current_entry+=$REPLY
            fi
        else
            entries+=("$current_entry")
            current_entry=""
        fi
    done < $collection
    for entry in "${entries[@]}"; do
        item=$(echo "$entry" | sed -n 's/^@.*{\(.*\),/\1/p')
        if grep -q "bib:" <(echo $item); then
            replace='s/bib://'
            item=$(echo $item | sed $replace)
            entry=$(echo "$entry" | sed $replace)
        fi
        bibfile=${bib_dir}/${item}.bib
        if [ -f $bibfile ]; then
            if [ $apply_patch -eq 1 ]; then
                diff --color <(echo "$entry") <(cat $bibfile) | patch --no-backup-if-mismatch $collection -
            else
                diff --color <(echo "$entry") <(cat $bibfile)
            fi
        else
            echo "Entry ${item} not found in library!"
        fi
    done
}

# parse args
if [ $# -lt 1 ]; then
    echo "No subcommand given!"
    exit -1
fi

cmd=$1
shift
# avoiding name clashes with builtins/system tools
if [ "$cmd" == "open" ]; then
    cmd="do_open"
elif [ "$cmd" == "diff" ]; then
    cmd="do_diff"
fi

# defaults for named args
usedoi=0
fzfprg="fzf"
output="/dev/stdout"
apply_patch=0

posargs=()
while [ $# -gt 0 ]; do
    case $1 in
        -o|--output)
            output=$2
            shift
            ;;
        -p|--prefix)
            prefix=$2
            shift
            ;;
        --doi)
            usedoi=1
            ;;
        --gui)
            fzfprg="gfzf"
            ;;
        --apply)
            apply_patch=1
            ;;
        *)
            posargs+=($1)
            ;;
    esac
    shift
done

# perform the command
$cmd ${posargs[@]}
